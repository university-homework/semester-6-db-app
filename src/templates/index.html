<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>index</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            line-height: 1.6;
            color: #333;
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
        }
        h2 {
            color: #3498db;
            border-bottom: 2px solid #3498db;
            padding-bottom: 5px;
            margin-top: 40px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 30px;
            box-shadow: 0 2px 3px rgba(0,0,0,0.1);
        }
        th {
            background-color: #3498db;
            color: white;
            text-align: left;
            padding: 10px;
        }
        td {
            border: 1px solid #ddd;
            padding: 8px;
        }
        tr:nth-child(even) {
            background-color: #f2f2f2;
        }
        tr:hover {
            background-color: #e6f7ff;
        }
        .loading {
            color: #7f8c8d;
            font-style: italic;
        }
        .error {
            color: #e74c3c;
            font-weight: bold;
        }
        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #2980b9;
        }
        .actions {
            margin: 20px 0;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .btn-success {
            background-color: #28a745;
        }
        .btn-danger {
            background-color: #dc3545;
        }
        .btn-warning {
            background-color: #ffc107;
            color: #212529;
        }
        .btn-login {
            background-color: #6c757d;
        }
        .btn-logout {
            background-color: #343a40;
        }
        .auth-status {
            margin-left: auto;
            padding: 8px 15px;
            border-radius: 4px;
            background-color: #f8f9fa;
            color: #212529;
            border: 1px solid #dee2e6;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 10% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 600px;
            border-radius: 5px;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close:hover {
            color: black;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .action-buttons {
            display: flex;
            gap: 5px;
        }
    </style>
</head>
<body>
    <h1>–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞ –æ–Ω–ª–∞–π–Ω –æ–±—É—á–µ–Ω–∏—è</h1>

    <div class="actions">
        <button onclick="loadAllData()">–û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
        <button id="loginBtn" class="btn-login" onclick="toggleAuth()">–ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è</button>
        <div id="authStatus" class="auth-status">–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω</div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h2 id="modalTitle">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</h2>
            <form id="editForm">
                <div id="formFields"></div>
                <div class="actions">
                    <button type="button" class="btn-success" onclick="submitForm()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                    <button type="button" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
                </div>
            </form>
        </div>
    </div>
    <h2>–£—á–∞—Å—Ç–Ω–∏–∫–∏ –∫—É—Ä—Å–æ–≤</h2>
    <div id="membersTable">
        <p class="loading">–î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è...</p>
    </div>

    <h2>–ö—É—Ä—Å—ã —Å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</h2>
    <div id="coursesWithMembersTable">
        <p class="loading">–î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è...</p>
    </div>

    <h2>–ú–æ–¥—É–ª–∏ –∫—É—Ä—Å–æ–≤</h2>
    <div id="coursesModulesTable">
        <p class="loading">–î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è...</p>
    </div>

    <h2>–£—Ä–æ–∫–∏</h2>
    <div id="lessonsTable">
        <p class="loading">–î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è...</p>
    </div>

    <h2>–í–æ–ø—Ä–æ—Å—ã</h2>
    <div id="questionsTable">
        <p class="loading">–î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è...</p>
    </div>
    <button id="addQuestionBtn" class="btn-success" onclick="openCreateModal('/core/questions/')" style="display: none;">–î–æ–±–∞–≤–∏—Ç—å –≤–æ–ø—Ä–æ—Å</button>

    <script>
        const API_BASE_URL = 'http://127.0.0.1:8000';
        let currentEditingId = null;
        let currentEndpoint = null;
        let isAuthenticated = false;

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        function toggleAuth() {
            isAuthenticated = !isAuthenticated;
            updateAuthUI();
            loadAllData();
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        function updateAuthUI() {
            const loginBtn = document.getElementById('loginBtn');
            const authStatus = document.getElementById('authStatus');
            const addQuestionBtn = document.getElementById('addQuestionBtn');

            if (isAuthenticated) {
                loginBtn.textContent = '–í—ã–π—Ç–∏';
                loginBtn.className = 'btn-logout';
                authStatus.textContent = '–ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω';
                authStatus.style.backgroundColor = '#d4edda';
                authStatus.style.color = '#155724';
                authStatus.style.borderColor = '#c3e6cb';
                addQuestionBtn.style.display = 'block';
            } else {
                loginBtn.textContent = '–ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è';
                loginBtn.className = 'btn-login';
                authStatus.textContent = '–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω';
                authStatus.style.backgroundColor = '#f8f9fa';
                authStatus.style.color = '#212529';
                authStatus.style.borderColor = '#dee2e6';
                addQuestionBtn.style.display = 'none';
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö
        async function fetchData(endpoint, method = 'GET', body = null) {
            const config = {
                method: method,
                mode: 'cors',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json',
                },
            };

            if (body && (method === 'POST' || method === 'PUT' || method === 'PATCH')) {
                config.body = JSON.stringify(body);
            }

            try {
                const response = await fetch(`${API_BASE_URL}${endpoint}`, config);
                if (!response.ok) {
                    throw new Error(`–û—à–∏–±–∫–∞ HTTP: ${response.status}`);
                }
                return await response.json();
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö:', error);
                showError(error.message);
                return null;
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã —Å —É—á–µ—Ç–æ–º –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞
        function renderTable(data, containerId, fields, endpoint) {
            const container = document.getElementById(containerId);

            if (!data || data.length === 0) {
                container.innerHTML = '<p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</p>';
                return;
            }

            let html = '<table><thead><tr>';

            // –ó–∞–≥–æ–ª–æ–≤–∫–∏ —Ç–∞–±–ª–∏—Ü—ã
            fields.forEach(field => {
                html += `<th>${field}</th>`;
            });

            if (isAuthenticated) {
                html += '<th>–î–µ–π—Å—Ç–≤–∏—è</th>';
            }

            html += '</tr></thead><tbody>';

            // –î–∞–Ω–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã
            data.forEach(item => {
                html += '<tr>';
                fields.forEach(field => {
                    html += `<td>${item[field] ?? '-'}</td>`;
                });

                if (isAuthenticated) {
                    html += `<td class="action-buttons">
                        <button class="btn-warning" onclick="openEditModal('${endpoint}', ${item.id})">‚úèÔ∏è</button>
                        <button class="btn-danger" onclick="deleteItem('${endpoint}', ${item.id})">üóëÔ∏è</button>
                    </td>`;
                }

                html += '</tr>';
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        async function openEditModal(endpoint, id) {
            if (!isAuthenticated) {
                showError('–î–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —ç—Ç–æ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è');
                return;
            }

            currentEditingId = id;
            currentEndpoint = endpoint;

            const data = await fetchData(`${endpoint}${id}/`);
            if (!data) return;

            document.getElementById('modalTitle').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–æ–ø—Ä–æ—Å–∞';
            const formFields = document.getElementById('formFields');
            formFields.innerHTML = '';

            for (const [key, value] of Object.entries(data)) {
                if (key === 'id') continue;

                const div = document.createElement('div');
                div.className = 'form-group';

                const label = document.createElement('label');
                label.textContent = key;
                label.htmlFor = key;

                let input;
                if (typeof value === 'string' && value.length > 50) {
                    input = document.createElement('textarea');
                    input.rows = 4;
                } else {
                    input = document.createElement('input');
                    input.type = 'text';
                }

                input.id = key;
                input.name = key;
                input.value = value || '';

                div.appendChild(label);
                div.appendChild(input);
                formFields.appendChild(div);
            }

            document.getElementById('editModal').style.display = 'block';
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Å–æ–∑–¥–∞–Ω–∏—è
        function openCreateModal(endpoint) {
            if (!isAuthenticated) {
                showError('–î–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —ç—Ç–æ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è');
                return;
            }

            currentEditingId = null;
            currentEndpoint = endpoint;

            document.getElementById('modalTitle').textContent = '–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞';
            const formFields = document.getElementById('formFields');
            formFields.innerHTML = '';

            const fields = [
                { name: 'lesson_id', label: 'ID —É—Ä–æ–∫–∞', type: 'number' },
                { name: 'content', label: '–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –≤–æ–ø—Ä–æ—Å–∞', type: 'textarea' }
            ];

            fields.forEach(field => {
                const div = document.createElement('div');
                div.className = 'form-group';

                const label = document.createElement('label');
                label.textContent = field.label;
                label.htmlFor = field.name;

                const input = field.type === 'textarea'
                    ? document.createElement('textarea')
                    : document.createElement('input');

                if (input.tagName === 'INPUT') {
                    input.type = field.type || 'text';
                } else {
                    input.rows = 4;
                }

                input.id = field.name;
                input.name = field.name;

                div.appendChild(label);
                div.appendChild(input);
                formFields.appendChild(div);
            });

            document.getElementById('editModal').style.display = 'block';
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
        function closeModal() {
            document.getElementById('editModal').style.display = 'none';
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã
        async function submitForm() {
            const form = document.getElementById('editForm');
            const formData = new FormData(form);
            const data = {};

            formData.forEach((value, key) => {
                data[key] = value;
            });

            let result;
            if (currentEditingId) {
                result = await fetchData(
                    `${currentEndpoint}${currentEditingId}/`,
                    'PUT',
                    data
                );
            } else {
                result = await fetchData(
                    currentEndpoint,
                    'POST',
                    data
                );
            }

            if (result) {
                closeModal();
                loadAllData();
                showSuccess(currentEditingId ? '–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω—ã' : '–ó–∞–ø–∏—Å—å —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞');
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –∑–∞–ø–∏—Å–∏
        async function deleteItem(endpoint, id) {
            if (!isAuthenticated) {
                showError('–î–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —ç—Ç–æ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è');
                return;
            }

            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–ø–∏—Å—å?')) {
                const result = await fetchData(
                    `${endpoint}${id}/`,
                    'DELETE'
                );

                loadAllData();
                showSuccess('–ó–∞–ø–∏—Å—å —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–∞');
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö
        async function loadAllData() {
            try {
                const members = await fetchData('/core/members/');
                if (members) {
                    renderTable(members, 'membersTable', ['id', 'user_id', 'course_id', 'status'], '/core/members/');
                }

                const coursesWithMembers = await fetchData('/core/courses/with-members-stats/');
                if (coursesWithMembers) {
                    renderTable(coursesWithMembers, 'coursesWithMembersTable', ['id', 'name', 'member_count', 'percentage'], '/core/courses/with-members-stats/');
                }

                const modulesWithLessons = await fetchData('/core/modules/lesson-counts/');
                if (modulesWithLessons) {
                    renderTable(modulesWithLessons, 'coursesModulesTable', ['id', 'name', 'lesson_count', 'rank'], '/core/modules/');
                }

                const lessons = await fetchData('/core/lessons/');
                if (lessons) {
                    renderTable(lessons, 'lessonsTable', ['id', 'module_id', 'name', 'file_path'], '/core/lessons/');
                }

                const questions = await fetchData('/core/questions/');
                if (questions) {
                    renderTable(questions, 'questionsTable', ['id', 'lesson_id', 'content'], '/core/questions/');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö:', error);
                showError('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –¥–ª—è –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–µ–π.');
            }
        }

        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.textContent = message;
            document.body.prepend(errorDiv);
            setTimeout(() => errorDiv.remove(), 5000);
        }

        function showSuccess(message) {
            const successDiv = document.createElement('div');
            successDiv.style.background = '#28a745';
            successDiv.style.color = 'white';
            successDiv.style.padding = '10px';
            successDiv.style.margin = '10px 0';
            successDiv.style.borderRadius = '4px';
            successDiv.textContent = message;
            document.body.prepend(successDiv);
            setTimeout(() => successDiv.remove(), 3000);
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', () => {
            updateAuthUI();
            loadAllData();

            window.onclick = function(event) {
                const modal = document.getElementById('editModal');
                if (event.target === modal) {
                    closeModal();
                }
            }
        });
    </script>
</body>
</html>