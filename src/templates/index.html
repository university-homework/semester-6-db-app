<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞ –æ–Ω–ª–∞–π–Ω –æ–±—É—á–µ–Ω–∏—è</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            line-height: 1.6;
            color: #333;
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
        }
        h2 {
            color: #3498db;
            border-bottom: 2px solid #3498db;
            padding-bottom: 5px;
            margin-top: 40px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 30px;
            box-shadow: 0 2px 3px rgba(0,0,0,0.1);
        }
        th {
            background-color: #3498db;
            color: white;
            text-align: left;
            padding: 10px;
        }
        td {
            border: 1px solid #ddd;
            padding: 8px;
        }
        tr:nth-child(even) {
            background-color: #f2f2f2;
        }
        tr:hover {
            background-color: #e6f7ff;
        }
        .loading {
            color: #7f8c8d;
            font-style: italic;
        }
        .error {
            color: #e74c3c;
            font-weight: bold;
        }
        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #2980b9;
        }
        .actions {
            margin: 20px 0;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }
        select {
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #ddd;
            min-width: 250px;
        }
        .btn-success {
            background-color: #28a745;
        }
        .btn-danger {
            background-color: #dc3545;
        }
        .btn-warning {
            background-color: #ffc107;
            color: #212529;
        }
        .btn-login {
            background-color: #6c757d;
        }
        .btn-logout {
            background-color: #343a40;
        }
        .auth-status {
            margin-left: auto;
            padding: 8px 15px;
            border-radius: 4px;
            background-color: #f8f9fa;
            color: #212529;
            border: 1px solid #dee2e6;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
        }
        .modal-content {
            background-color: #fefefe;
            margin: 10% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 600px;
            border-radius: 5px;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close:hover {
            color: black;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .action-buttons {
            display: flex;
            gap: 5px;
        }
        #mostPopularCourse {
            font-size: 20px;
        }
        .course-stats {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .course-stats h3 {
            margin-top: 0;
            color: #2c3e50;
        }
    </style>
</head>
<body>
    <h1>–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞ –æ–Ω–ª–∞–π–Ω –æ–±—É—á–µ–Ω–∏—è</h1>

    <div class="actions">
        <select id="courseSelect" onchange="loadCourseStats()">
            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫—É—Ä—Å</option>
            <!-- –û–ø—Ü–∏–∏ –±—É–¥—É—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
        </select>
        <button onclick="loadAllData()">–û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
        <button id="loginBtn" class="btn-login" onclick="toggleAuth()">–ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è</button>
        <div id="authStatus" class="auth-status">–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω</div>
    </div>

    <div id="selectedCourseStats" class="course-stats">
        <h3>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫—É—Ä—Å–∞</h3>
        <p>–í—ã–±–µ—Ä–∏—Ç–µ –∫—É—Ä—Å –∏–∑ —Å–ø–∏—Å–∫–∞, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É</p>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h2 id="modalTitle">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</h2>
            <form id="editForm">
                <div id="formFields"></div>
                <div class="actions">
                    <button type="button" class="btn-success" onclick="submitForm()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                    <button type="button" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
                </div>
            </form>
        </div>
    </div>

    <h2>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–∏—Å—Ç–µ–º—ã</h2>
    <div id="systemStatsTable">
        <p class="loading">–î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è...</p>
    </div>

    <h2>–°–∞–º—ã–π –ø–æ–ø—É–ª—è—Ä–Ω—ã–π –∫—É—Ä—Å</h2>
    <div id="mostPopularCourseTable">
        <p class="loading">–î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è...</p>
    </div>

    <h2>–ö—É—Ä—Å —Å –Ω–∞–∏–±–æ–ª—å—à–∏–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º —É—Ä–æ–∫–æ–≤</h2>
    <div id="courseWithReachestContentTable">
        <p class="loading">–î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è...</p>
    </div>

    <h2>–ö—É—Ä—Å—ã –±–µ–∑ –º–æ–¥—É–ª–µ–π (—Ç—Ä–µ–±—É—é—Ç –¥–æ—Ä–∞–±–æ—Ç–∫–∏)</h2>
    <div id="coursesWithoutModulesTable">
        <p class="loading">–î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è...</p>
    </div>

    <h2>–£—á–∞—Å—Ç–Ω–∏–∫–∏ –∫—É—Ä—Å–æ–≤</h2>
    <div id="membersTable">
        <p class="loading">–î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è...</p>
    </div>

    <h2>–ö—É—Ä—Å—ã —Å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</h2>
    <div id="coursesWithMembersTable">
        <p class="loading">–î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è...</p>
    </div>

    <h2>–ú–æ–¥—É–ª–∏ –∫—É—Ä—Å–æ–≤</h2>
    <div id="coursesModulesTable">
        <p class="loading">–î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è...</p>
    </div>

    <h2>–£—Ä–æ–∫–∏</h2>
    <div id="lessonsTable">
        <p class="loading">–î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è...</p>
    </div>

    <h2>–í–æ–ø—Ä–æ—Å—ã</h2>
    <div id="questionsTable">
        <p class="loading">–î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è...</p>
    </div>
    <button id="addQuestionBtn" class="btn-success" onclick="openCreateQuestionModal('/base/questions/')" style="display: none;">–î–æ–±–∞–≤–∏—Ç—å –≤–æ–ø—Ä–æ—Å</button>

    <script>
        const API_BASE_URL = 'http://127.0.0.1:8000';

        let currentEditingId = null;
        let currentEndpoint = null;
        let isAuthenticated = false;

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        function toggleAuth() {
            isAuthenticated = !isAuthenticated;
            updateAuthUI();
            loadAllData();
        }

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        function updateAuthUI() {
            const loginBtn = document.getElementById('loginBtn');
            const authStatus = document.getElementById('authStatus');
            const addQuestionBtn = document.getElementById('addQuestionBtn');

            if (isAuthenticated) {
                loginBtn.textContent = '–í—ã–π—Ç–∏';
                loginBtn.className = 'btn-logout';
                authStatus.textContent = '–ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω';
                authStatus.style.backgroundColor = '#d4edda';
                authStatus.style.color = '#155724';
                authStatus.style.borderColor = '#c3e6cb';
                addQuestionBtn.style.display = 'block';
            } else {
                loginBtn.textContent = '–ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è';
                loginBtn.className = 'btn-login';
                authStatus.textContent = '–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω';
                authStatus.style.backgroundColor = '#f8f9fa';
                authStatus.style.color = '#212529';
                authStatus.style.borderColor = '#dee2e6';
                addQuestionBtn.style.display = 'none';
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö
        async function fetchData(endpoint, method = 'GET', body = null) {
            const config = {
                method: method,
                mode: 'cors',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json',
                },
            };

            if (body && (method === 'POST' || method === 'PUT' || method === 'PATCH')) {
                config.body = JSON.stringify(body);
            }

            try {
                const response = await fetch(`${API_BASE_URL}${endpoint}`, config);
                if (!response.ok) {
                    throw new Error(`–û—à–∏–±–∫–∞ HTTP: ${response.status}`);
                }
                return await response.json();
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö:', error);
                showError(error.message);
                return null;
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã —Å —É—á–µ—Ç–æ–º –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞
        function renderTable(data, containerId, fields, tableHeaders) {
            const container = document.getElementById(containerId);

            if (!data || data.length === 0) {
                container.innerHTML = '<p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</p>';
                return;
            }

            let html = '<table><thead><tr>';

            // –ó–∞–≥–æ–ª–æ–≤–∫–∏ —Ç–∞–±–ª–∏—Ü—ã
            tableHeaders.forEach(field => {
                html += `<th>${field}</th>`;
            });

            html += '</tr></thead><tbody>';

            // –î–∞–Ω–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã
            data.forEach(item => {
                html += '<tr>';
                fields.forEach(field => {
                    html += `<td>${item[field] ?? '-'}</td>`;
                });

                html += '</tr>';
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function renderMembersTable(data) {
            const container = document.getElementById('membersTable');
            const fields = ['id', 'user', 'course', 'status'];
            const tableHeaders = ['id', '–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å', '–∫—É—Ä—Å', '—Å—Ç–∞—Ç—É—Å'];

            if (!data || data.length === 0) {
                container.innerHTML = '<p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</p>';
                return;
            }

            let html = '<table><thead><tr>';

            // –ó–∞–≥–æ–ª–æ–≤–∫–∏ —Ç–∞–±–ª–∏—Ü—ã
            tableHeaders.forEach(item => {
                html += `<th>${item}</th>`;    
            });

            html += '</tr></thead><tbody>';

            // –î–∞–Ω–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã
            data.forEach(item => {
                html += '<tr>';
                fields.forEach(field => {
                    if (field === 'user') {
                        html += `<td>${item[field]['username'] ?? '-'}</td>`;
                    }
                    else if (field === 'course') {
                        html += `<td>${item[field]['name'] ?? '-'}</td>`;
                    }
                    else {
                        html += `<td>${item[field] ?? '-'}</td>`;
                    }
                });
                html += '</tr>';
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function renderLessonsTable(data) {
            const container = document.getElementById('lessonsTable');
            const fields = ['id', 'module', 'name', 'file_path'];
            const tableHeaders = ['id', '–º–æ–¥—É–ª—å', '–Ω–∞–∑–≤–∞–Ω–∏–µ', '–ø—É—Ç—å –¥–æ —Ñ–∞–π–ª–∞'];

            if (!data || data.length === 0) {
                container.innerHTML = '<p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</p>';
                return;
            }

            let html = '<table><thead><tr>';

            // –ó–∞–≥–æ–ª–æ–≤–∫–∏ —Ç–∞–±–ª–∏—Ü—ã
            tableHeaders.forEach(item => {
                html += `<th>${item}</th>`;    
            });

            html += '</tr></thead><tbody>';

            // –î–∞–Ω–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã
            data.forEach(item => {
                html += '<tr>';
                fields.forEach(field => {
                    if (field === 'module') {
                        html += `<td>${item[field]['name'] ?? '-'}</td>`;
                    }
                    else {
                        html += `<td>${item[field] ?? '-'}</td>`;
                    }
                });
                html += '</tr>';
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function renderQuestionsTable(data) {
            const container = document.getElementById('questionsTable');
            const fields = ['id', 'lesson', 'content'];
            const tableHeaders = ['id', '—É—Ä–æ–∫', '–≤–æ–ø—Ä–æ—Å'];
            const endpoint = '/base/questions/'

            if (!data || data.length === 0) {
                container.innerHTML = '<p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</p>';
                return;
            }

            let html = '<table><thead><tr>';

            // –ó–∞–≥–æ–ª–æ–≤–∫–∏ —Ç–∞–±–ª–∏—Ü—ã
            tableHeaders.forEach(item => {
                html += `<th>${item}</th>`;    
            });

            if (isAuthenticated) {
                html += '<th>–î–µ–π—Å—Ç–≤–∏—è</th>';
            }

            html += '</tr></thead><tbody>';

            // –î–∞–Ω–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã
            data.forEach(item => {
                html += '<tr>';
                fields.forEach(field => {
                    if (field === 'lesson') {
                        html += `<td>${item[field]['name'] ?? '-'}</td>`;
                    }
                    else {
                        html += `<td>${item[field] ?? '-'}</td>`;
                    }
                });

                if (isAuthenticated) {
                    html += `<td class="action-buttons">
                        <button class="btn-warning" onclick="openQuestionEditModal('${endpoint}', ${item.id})">‚úèÔ∏è</button>
                        <button class="btn-danger" onclick="deleteItem('${endpoint}', ${item.id})">üóëÔ∏è</button>
                    </td>`;
                }

                html += '</tr>';
            });

            html += '</tbody></table>';
            container.innerHTML = html;
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Å–æ–∑–¥–∞–Ω–∏—è –≤–æ–ø—Ä–æ—Å–∞
        async function openCreateQuestionModal(endpoint) {
            if (!isAuthenticated) {
                showError('–î–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —ç—Ç–æ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è');
                return;
            }

            currentEditingId = null;
            currentEndpoint = endpoint;

            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ —É—Ä–æ–∫–æ–≤
            const lessons = await fetchData('/base/lessons/');
            if (!lessons) return;

            document.getElementById('modalTitle').textContent = '–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞';
            const formFields = document.getElementById('formFields');
            formFields.innerHTML = '';

            // –ü–æ–ª–µ –¥–ª—è –≤—ã–±–æ—Ä–∞ —É—Ä–æ–∫–∞
            const lessonDiv = document.createElement('div');
            lessonDiv.className = 'form-group';

            const lessonLabel = document.createElement('label');
            lessonLabel.textContent = '–£—Ä–æ–∫';
            lessonLabel.htmlFor = 'lesson_id';

            const lessonSelect = document.createElement('select');
            lessonSelect.id = 'lesson_id';
            lessonSelect.name = 'lesson_id';

            // –î–æ–±–∞–≤–ª—è–µ–º –æ–ø—Ü–∏–∏ –≤ –≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫
            lessons.forEach(lesson => {
                const option = document.createElement('option');
                option.value = lesson.id;
                option.textContent = `${lesson.name} (ID: ${lesson.id})`;
                lessonSelect.appendChild(option);
            });

            lessonDiv.appendChild(lessonLabel);
            lessonDiv.appendChild(lessonSelect);
            formFields.appendChild(lessonDiv);

            // –ü–æ–ª–µ –¥–ª—è —Å–æ–¥–µ—Ä–∂–∞–Ω–∏—è –≤–æ–ø—Ä–æ—Å–∞
            const contentDiv = document.createElement('div');
            contentDiv.className = 'form-group';

            const contentLabel = document.createElement('label');
            contentLabel.textContent = '–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –≤–æ–ø—Ä–æ—Å–∞';
            contentLabel.htmlFor = 'content';

            const contentInput = document.createElement('textarea');
            contentInput.id = 'content';
            contentInput.name = 'content';
            contentInput.rows = 4;

            contentDiv.appendChild(contentLabel);
            contentDiv.appendChild(contentInput);
            formFields.appendChild(contentDiv);

            document.getElementById('editModal').style.display = 'block';
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤–æ–ø—Ä–æ—Å–∞
        async function openQuestionEditModal(endpoint, id) {
            currentEditingId = id;
            currentEndpoint = endpoint;

            // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –≤–æ–ø—Ä–æ—Å–∞ –∏ —Å–ø–∏—Å–æ–∫ —É—Ä–æ–∫–æ–≤
            const [question, lessons] = await Promise.all([
                fetchData(`${endpoint}${id}/`),
                fetchData('/base/lessons/')
            ]);
            
            if (!question || !lessons) return;

            document.getElementById('modalTitle').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–æ–ø—Ä–æ—Å–∞';
            const formFields = document.getElementById('formFields');
            formFields.innerHTML = '';

            // –ü–æ–ª–µ –¥–ª—è –≤—ã–±–æ—Ä–∞ —É—Ä–æ–∫–∞
            const lessonDiv = document.createElement('div');
            lessonDiv.className = 'form-group';

            const lessonLabel = document.createElement('label');
            lessonLabel.textContent = '–£—Ä–æ–∫';
            lessonLabel.htmlFor = 'lesson_id';

            const lessonSelect = document.createElement('select');
            lessonSelect.id = 'lesson_id';
            lessonSelect.name = 'lesson_id';

            // –î–æ–±–∞–≤–ª—è–µ–º –æ–ø—Ü–∏–∏ –≤ –≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫
            lessons.forEach(lesson => {
                const option = document.createElement('option');
                option.value = lesson.id;
                option.textContent = `${lesson.name} (ID: ${lesson.id})`;
                option.selected = (lesson.id === question.lesson_id);
                lessonSelect.appendChild(option);
            });

            lessonDiv.appendChild(lessonLabel);
            lessonDiv.appendChild(lessonSelect);
            formFields.appendChild(lessonDiv);

            // –ü–æ–ª–µ –¥–ª—è —Å–æ–¥–µ—Ä–∂–∞–Ω–∏—è –≤–æ–ø—Ä–æ—Å–∞
            const contentDiv = document.createElement('div');
            contentDiv.className = 'form-group';

            const contentLabel = document.createElement('label');
            contentLabel.textContent = '–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –≤–æ–ø—Ä–æ—Å–∞';
            contentLabel.htmlFor = 'content';

            const contentInput = document.createElement('textarea');
            contentInput.id = 'content';
            contentInput.name = 'content';
            contentInput.rows = 4;
            contentInput.value = question.content || '';

            contentDiv.appendChild(contentLabel);
            contentDiv.appendChild(contentInput);
            formFields.appendChild(contentDiv);

            document.getElementById('editModal').style.display = 'block';
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
        function closeModal() {
            document.getElementById('editModal').style.display = 'none';
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã
        async function submitForm() {
            const form = document.getElementById('editForm');
            const formData = new FormData(form);
            const data = {};

            formData.forEach((value, key) => {
                data[key] = value;
            });

            let result;
            if (currentEditingId) {
                result = await fetchData(
                    `${currentEndpoint}${currentEditingId}/`,
                    'PUT',
                    data
                );
            } else {
                result = await fetchData(
                    currentEndpoint,
                    'POST',
                    data
                );
            }

            if (result) {
                closeModal();
                loadAllData();
                showSuccess(currentEditingId ? '–î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω—ã' : '–ó–∞–ø–∏—Å—å —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞');
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –∑–∞–ø–∏—Å–∏
        async function deleteItem(endpoint, id) {
            if (!isAuthenticated) {
                showError('–î–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —ç—Ç–æ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è');
                return;
            }

            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–ø–∏—Å—å?')) {
                const result = await fetchData(
                    `${endpoint}${id}/`,
                    'DELETE'
                );

                loadAllData();
                showSuccess('–ó–∞–ø–∏—Å—å —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–∞');
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ –∫—É—Ä—Å–æ–≤ –≤ –≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫
        async function loadCourses() {
            const courses = await fetchData('/additional/all_courses/');
            if (!courses) return;
            
            const select = document.getElementById('courseSelect');
            
            // –û—á–∏—â–∞–µ–º –≤—Å–µ –æ–ø—Ü–∏–∏ –∫—Ä–æ–º–µ –ø–µ—Ä–≤–æ–π
            while (select.options.length > 1) {
                select.remove(1);
            }
            
            // –î–æ–±–∞–≤–ª—è–µ–º –∫—É—Ä—Å—ã –≤ –≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫
            courses.forEach(course => {
                const option = document.createElement('option');
                option.value = course.id;
                option.textContent = `${course.name} (ID: ${course.id})`;
                select.appendChild(option);
            });
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –∫—É—Ä—Å–∞
        async function loadCourseStats() {
            const select = document.getElementById('courseSelect');
            const courseId = select.value;
            
            if (!courseId) {
                document.getElementById('selectedCourseStats').innerHTML = 
                    '<h3>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫—É—Ä—Å–∞</h3><p>–í—ã–±–µ—Ä–∏—Ç–µ –∫—É—Ä—Å –∏–∑ —Å–ø–∏—Å–∫–∞, —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É</p>';
                return;
            }
            
            const stats = await fetchData(`/additional/courses/${courseId}/stats/`);
            if (!stats) return;
            
            const container = document.getElementById('selectedCourseStats');
            
            // –§–æ—Ä–º–∏—Ä—É–µ–º HTML –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
            let html = `
                <h3>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫—É—Ä—Å–∞: ${stats.course_name}</h3>
                <table>
                    <thead>
                        <tr>
                            <th>–ú–æ–¥—É–ª–∏</th>
                            <th>–£—Ä–æ–∫–∏</th>
                            <th>–£—á–∞—Å—Ç–Ω–∏–∫–∏</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>${stats.module_count}</td>
                            <td>${stats.lesson_count}</td>
                            <td>${stats.member_count}</td>
                        </tr>
                    </tbody>
                </table>
                <p><strong>ID –∫—É—Ä—Å–∞:</strong> ${stats.course_id}</p>
            `;
            
            container.innerHTML = html;
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö
        async function loadAllData() {
            try {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –∫—É—Ä—Å–æ–≤ –¥–ª—è –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞
                await loadCourses();
                
                const systemStats = await fetchData('/additional/system/stats/');
                if (systemStats) {
                    renderTable(
                        systemStats,
                        'systemStatsTable',
                        ['modules', 'lessons', 'questions', 'members', 'updated_at'],
                        ['–º–æ–¥—É–ª–∏', '—É—Ä–æ–∫–∏', '–∫—É—Ä—Å—ã', '—É—á–∞—Å—Ç–Ω–∏–∫–∏', '–≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏'],
                    );
                }

                const mostPopularCourse = await fetchData('/additional/courses/most-popular/');
                if (mostPopularCourse) {
                    renderTable(
                        mostPopularCourse,
                        'mostPopularCourseTable',
                        ['course', 'members_count'],
                        ['–∫—É—Ä—Å', '–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤'],
                    );
                }

                const courseWithReachestContent = await fetchData('/additional/courses/richest-content/');
                if (courseWithReachestContent) {
                    renderTable(
                        courseWithReachestContent,
                        'courseWithReachestContentTable',
                        ['course', 'lessons_count'],
                        ['–∫—É—Ä—Å', '–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—Ä–æ–∫–æ–≤'],
                    );
                }

                const coursesWithoutModules = await fetchData('/additional/courses/without-modules/');
                if (coursesWithoutModules) {
                    renderTable(
                        coursesWithoutModules,
                        'coursesWithoutModulesTable',
                        ['course'],
                        ['–∫—É—Ä—Å'],
                    );
                }

                const members = await fetchData('/base/members/');
                if (members) {
                    renderMembersTable(members);
                }

                const coursesWithMembers = await fetchData('/base/courses/with-members-stats/');
                if (coursesWithMembers) {
                    renderTable(
                        coursesWithMembers,
                        'coursesWithMembersTable',
                        ['id', 'name', 'member_count', 'percentage'],
                        ['id', '–Ω–∞–∑–≤–∞–Ω–∏–µ', '–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤', '–ø—Ä–æ—Ü–µ–Ω—Ç']
                    );
                }

                const modulesWithLessons = await fetchData('/base/modules/lesson-counts/');
                if (modulesWithLessons) {
                    renderTable(
                        modulesWithLessons,
                        'coursesModulesTable',
                        ['id', 'name', 'lesson_count', 'rank'],
                        ['id', '–Ω–∞–∑–≤–∞–Ω–∏–µ', '–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—Ä–æ–∫–æ–≤', '—Ä–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏–µ'],
                    );
                }

                const lessons = await fetchData('/base/lessons/');
                if (lessons) {
                    renderLessonsTable(lessons);
                }

                const questions = await fetchData('/base/questions/');
                if (questions) {
                    renderQuestionsTable(questions);
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö:', error);
                showError('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –¥–ª—è –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–µ–π.');
            }
        }

        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error';
            errorDiv.textContent = message;
            document.body.prepend(errorDiv);
            setTimeout(() => errorDiv.remove(), 5000);
        }

        function showSuccess(message) {
            const successDiv = document.createElement('div');
            successDiv.style.background = '#28a745';
            successDiv.style.color = 'white';
            successDiv.style.padding = '10px';
            successDiv.style.margin = '10px 0';
            successDiv.style.borderRadius = '4px';
            successDiv.textContent = message;
            document.body.prepend(successDiv);
            setTimeout(() => successDiv.remove(), 3000);
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', () => {
            updateAuthUI();
            loadAllData();

            window.onclick = function(event) {
                const modal = document.getElementById('editModal');
                if (event.target === modal) {
                    closeModal();
                }
            }
        });
    </script>
</body>
</html>